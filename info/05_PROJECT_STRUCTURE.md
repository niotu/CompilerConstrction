# Структура проекта O Language Compiler

## Обзор структуры директорий

```
CompilerConstrction/
├── build/                      # Скомпилированные DLL и runtime конфигурации
├── info/                       # Документация проекта (этот файл и другие)
├── src/                        # Исходный код компилятора
│   └── OCompiler/             # Основной проект компилятора
│       ├── CodeGeneration/    # Генерация IL-кода
│       ├── Lexer/             # Лексический анализатор
│       ├── Parser/            # Синтаксический анализатор
│       ├── Runtime/           # Интерпретатор (fallback)
│       ├── Semantic/          # Семантический анализатор
│       └── Utils/             # Вспомогательные классы
├── test-results/              # Результаты прогона тестов
├── tests/                     # Тестовые программы на языке O
├── *.md                       # Документация
├── *.sh, *.ps1               # Скрипты для тестирования
└── *.sln, *.csproj           # Файлы проекта .NET
```

---

## Корневая директория

### README.md
**Назначение**: Основная документация проекта  
**Содержание**: 
- Описание языка O
- Инструкции по установке и запуску
- Список флагов командной строки
- Таблица интегрированных тестов

### ARCHITECTURE.md
**Назначение**: Детальное описание архитектуры компилятора  
**Содержание**:
- Описание всех фаз компиляции
- Структура классов и компонентов
- Процесс генерации IL-кода
- Известные ограничения и планы развития

### Project-O.txt
**Назначение**: Формальная спецификация языка O  
**Содержание**:
- Неформальная спецификация языка
- BNF-грамматика
- Описание встроенных типов (Integer, Real, Boolean, Array, List)
- Примеры кода на языке O

### CompilerConstruction.sln
**Назначение**: Solution-файл для Visual Studio / JetBrains Rider  
**Содержание**: Конфигурация проекта, ссылки на .csproj файлы

### global.json
**Назначение**: Конфигурация версии .NET SDK  
**Содержание**:
```json
{
  "sdk": {
    "version": "9.0.100",
    "rollForward": "latestMinor"
  }
}
```

### nuget.config
**Назначение**: Конфигурация источников NuGet пакетов  
**Содержание**: Настройка репозиториев для загрузки зависимостей

### run-tests.sh
**Назначение**: Bash-скрипт для запуска всех тестов (Linux/macOS)  
**Функции**:
- Компиляция компилятора
- Запуск всех тестов из `tests/`
- Генерация отчетов в `test-results/`
- Подсчет статистики прохождения тестов

**Использование**:
```bash
./run-tests.sh                    # Запустить все тесты
./run-tests.sh -v                 # С детальным выводом
./run-tests.sh --only-valid       # Только валидные тесты
./run-tests.sh --stop-on-error    # Остановка на первой ошибке
```

### run-test.ps1
**Назначение**: PowerShell-скрипт для запуска тестов (Windows)  
**Функции**: Аналогично run-tests.sh, но для Windows

### dotnet-install.sh
**Назначение**: Скрипт для установки .NET SDK  
**Использование**: Автоматическая установка требуемой версии .NET

### pe_check.py
**Назначение**: Python-скрипт для проверки корректности PE-файлов  
**Функции**: Валидация структуры сгенерированных .dll файлов

---

## Директория src/OCompiler/

### Program.cs
**Назначение**: Точка входа компилятора  
**Функции**:
- Парсинг аргументов командной строки
- Координация всех этапов компиляции
- Вывод результатов и обработка ошибок

**Основные методы**:
- `Main()` - точка входа
- `CompileFile()` - главная функция компиляции
- `SyntaxAnalysis()` - вызов парсера
- `SemanticAnalysisAndCodeGen()` - семантика и кодогенерация
- `GenerateCode()` - генерация IL

### OCompiler.csproj
**Назначение**: Файл проекта .NET  
**Содержание**:
- Зависимости (NuGet пакеты)
- Конфигурация компиляции
- Настройки C# 12.0 и .NET 9.0

---

## Директория src/OCompiler/Lexer/

### OLexer.cs
**Назначение**: Основной класс лексического анализатора  
**Функции**:
- Токенизация исходного кода
- Распознавание ключевых слов, идентификаторов, литералов
- Отслеживание позиций для ошибок

**Основные методы**:
- `Tokenize()` - главный метод токенизации
- `NextToken()` - получить следующий токен
- `ReadNumber()` - чтение числовых литералов
- `ReadIdentifierOrKeyword()` - чтение идентификаторов и ключевых слов

### Token.cs
**Назначение**: Представление токена  
**Поля**:
- `Type` - тип токена (TokenType)
- `Value` - текстовое значение
- `Position` - позиция в исходном коде

### TokenType.cs
**Назначение**: Перечисление типов токенов  
**Типы**:
- Ключевые слова: CLASS, METHOD, IS, END, IF, WHILE, RETURN, THIS, VAR, EXTENDS, LOOP, THEN, ELSE
- Идентификаторы: IDENTIFIER
- Литералы: INTEGER_LITERAL, REAL_LITERAL, BOOLEAN_LITERAL
- Операторы: ASSIGN (:=), ARROW (=>), DOT (.), COLON (:), COMMA (,)
- Разделители: LPAREN, RPAREN, LBRACKET, RBRACKET
- Специальные: COMMENT, EOF

### Position.cs
**Назначение**: Хранение информации о позиции в исходном коде  
**Поля**:
- `Line` - номер строки
- `Column` - номер столбца
- `FileName` - имя файла

### LexerException.cs
**Назначение**: Исключение для ошибок лексинга  
**Использование**: Бросается при неожиданных символах или некорректных токенах

### TokenInfo.cs
**Назначение**: Вспомогательная информация о токенах  
**Функции**: Утилиты для работы с токенами

---

## Директория src/OCompiler/Parser/

### Grammar.y
**Назначение**: BNF-грамматика языка O для GPPG  
**Содержание**:
- Токены и их приоритеты
- Правила грамматики (productions)
- Семантические действия (создание AST узлов)

**Пример правила**:
```yacc
ClassDeclaration
    : CLASS IDENTIFIER IS MemberList END
    {
        $$ = new ClassDeclaration($2, "", "", $4);
    }
    ;
```

### OParser.cs
**Назначение**: Сгенерированный LALR(1) парсер (из Grammar.y)  
**Генерация**: `gppg /gplex Grammar.y > OParser.cs`  
**Функции**:
- Shift-Reduce парсинг
- Построение AST
- Обработка синтаксических ошибок

### AstNodes.cs
**Назначение**: Определения всех типов узлов AST  
**Классы**:
- `AstNode` - базовый класс
- `ProgramNode` - корневой узел (программа)
- `ClassDeclaration` - объявление класса
- `MethodDeclaration` - объявление метода
- `ConstructorDeclaration` - объявление конструктора
- `VariableDeclaration` - объявление переменной
- `ExpressionNode` - выражение (базовый класс)
- `BinaryOperationNode` - бинарная операция
- `FunctionalCallNode` - вызов метода
- `ConstructorInvocation` - вызов конструктора
- `LiteralNode` - литерал (Integer, Real, Boolean, This)
- `Assignment` - присваивание
- `IfStatement` - условный оператор
- `WhileLoop` - цикл
- `ReturnStatement` - возврат значения

### ManualLexerAdapter.cs
**Назначение**: Адаптер между OLexer и GPPG парсером  
**Функции**: Преобразование списка токенов в поток для парсера

### ShiftReduceParserCode.cs
**Назначение**: Вспомогательный код для GPPG парсера  
**Функции**: Базовая логика shift-reduce автомата

---

## Директория src/OCompiler/Semantic/

### Checks.cs
**Назначение**: Основной класс семантического анализатора  
**Функции**:
- Проверка типов
- Разрешение символов
- Валидация наследования
- Проверка корректности вызовов
- Обнаружение дублирований

**Основные методы**:
- `Check()` - главная функция проверки
- `CheckClassHierarchy()` - проверка иерархии классов
- `CheckTypeCompatibility()` - проверка совместимости типов
- `CheckMethodOverriding()` - проверка переопределения методов
- `CheckReturnStatements()` - проверка return

### Hierarchy.cs
**Назначение**: Управление иерархией классов  
**Функции**:
- Хранение информации о классах
- Поддержка наследования
- Поиск методов и полей в иерархии

**Основные методы**:
- `AddClass()` - добавить класс
- `GetClass()` - получить информацию о классе
- `IsSubclassOf()` - проверка наследования
- `FindMethod()` - поиск метода в иерархии

### SymbolTable.cs
**Назначение**: Таблица символов для разрешения имен  
**Функции**:
- Хранение переменных и их типов
- Поддержка областей видимости (scopes)
- Разрешение имен переменных, методов, классов

**Основные методы**:
- `EnterScope()` - войти в новую область видимости
- `ExitScope()` - выйти из области видимости
- `Define()` - определить символ
- `Resolve()` - найти символ

### Optimizations.cs
**Назначение**: Оптимизации AST  
**Функции**:
- Constant folding (сворачивание констант)
- Dead code elimination (удаление мертвого кода)
- Simplification (упрощение выражений)

**Основные методы**:
- `Optimize()` - главная функция оптимизации
- `FoldConstants()` - сворачивание констант
- `EliminateDeadCode()` - удаление мертвого кода

### Директория Semantic/Types/
**Назначение**: Определения типов для семантического анализа  
**Файлы**:
- Определения символов (MethodSymbol, FieldSymbol, etc.)
- Типовая информация

---

## Директория src/OCompiler/CodeGeneration/

### CodeGenerator.cs
**Назначение**: Главный класс генератора IL-кода  
**Функции**:
- Создание AssemblyBuilder и ModuleBuilder
- Управление процессом генерации
- Создание TypeBuilder для классов
- Сохранение сборки в файл

**Основные методы**:
- `Generate()` - главная функция генерации
- `DeclareType()` - объявление типа класса
- `GenerateClassMembers()` - генерация полей, методов, конструкторов
- `GenerateEntryPoint()` - создание точки входа <Program>.Main()
- `SaveToFile()` - сохранение сборки в .dll

**Этапы генерации**:
1. Объявление типов (TypeBuilder)
2. Генерация членов (поля, конструкторы, методы)
3. Финализация типов (CreateTypeInfo())
4. Генерация точки входа
5. Сохранение в файл

### MethodGenerator.cs
**Назначение**: Генерация IL-кода для методов и конструкторов  
**Функции**:
- Генерация IL-инструкций для тел методов
- Обработка выражений, операторов
- Управление локальными переменными
- Вызовы методов и конструкторов

**Основные методы**:
- `DeclareConstructor()` - объявление конструктора
- `GenerateConstructorBody()` - генерация тела конструктора
- `DeclareMethod()` - объявление метода
- `GenerateMethodBody()` - генерация тела метода
- `GenerateExpression()` - генерация IL для выражения
- `GenerateStatement()` - генерация IL для оператора

**IL-инструкции**:
- `ldarg.0` - загрузка this
- `ldc.i4` - загрузка константы integer
- `stfld` - сохранение в поле
- `call` - вызов метода
- `ret` - возврат из метода

### TypeMapper.cs
**Назначение**: Маппинг типов O → .NET  
**Функции**:
- Преобразование имен типов O в .NET Type
- Инференция типов выражений
- Управление встроенными типами

**Маппинг**:
- Integer → System.Int32
- Real → System.Double
- Boolean → System.Boolean
- Array[T] → BuiltinTypes.OArray
- List[T] → List&lt;object&gt;

**Основные методы**:
- `MapType()` - получить .NET тип по имени O типа
- `InferType()` - вывести тип выражения
- `IsBuiltInType()` - проверка встроенного типа

### BuiltinTypes.cs
**Назначение**: Реализация встроенных типов O  
**Классы**:
- `OInteger` - обертка над System.Int32 с методами Plus, Minus, Mult, Div, etc.
- `OReal` - обертка над System.Double
- `OBoolean` - обертка над System.Boolean
- `OArray` - реализация Array[T]
- `OList` - обертка над List&lt;T&gt;

### ILEmitter.cs
**Назначение**: Утилиты для генерации текстового представления IL  
**Функции**:
- Форматирование IL-инструкций для вывода
- Генерация директив сборки
- Вспомогательные функции для --emit-il флага

### CecilHelpers.cs
**Назначение**: Утилиты для работы с Mono.Cecil  
**Функции**:
- Постобработка PE-файлов
- Установка EntryPoint в CLR header
- Модификация метаданных сборки

**Основной метод**:
- `SetEntryPointWithCecil()` - установка точки входа в PE header

---

## Директория src/OCompiler/Runtime/

### Interpreter.cs
**Назначение**: Fallback интерпретатор для выполнения конструкторов  
**Функции**:
- Tree-walking интерпретация AST
- Выполнение конструкторов в памяти
- Управление локальными переменными и полями

**Когда используется**:
- Когда прямой вызов через Reflection не работает
- Для динамических типов без полной поддержки в runtime

**Основные методы**:
- `ExecuteConstructorByName()` - выполнить конструктор по имени
- `ExecuteMethodBody()` - выполнить тело метода
- `EvaluateExpression()` - вычислить выражение

**Поддерживаемые конструкции**:
- Объявление переменных
- Присваивание
- Вызов конструкторов
- Вызов методов
- Return statements
- If statements
- While loops

**НЕ поддерживается**:
- Встроенные операции (Plus, Minus, etc.)
- Сложные выражения
- Array/List операции

---

## Директория src/OCompiler/Utils/

### CompilerException.cs
**Назначение**: Базовый класс исключений компилятора  
**Использование**: Все исключения компилятора наследуются от этого класса

---

## Директория tests/

Содержит 30 тестовых программ на языке O.

### Валидные тесты (должны компилироваться)

| Файл | Описание |
|------|----------|
| 01_Hello.o | Минимальная программа с конструктором |
| 02_MaxInt.o | Поиск максимума в массиве |
| 03_ArraySquare.o | Заполнение массива квадратами |
| 04_InheritanceValid.o | Наследование и переопределение методов |
| 05_OverloadValid.o | Перегрузка методов |
| 06_IfReduce.o | Условные операторы |
| 07_ConstructorArgs.o | Конструктор с аргументами |
| 08_RecursiveFactorial.o | Рекурсивный факториал |
| 09_ListAppend.o | Операции со списками |
| 10_Polymorphism.o | Полиморфизм |
| 19_IntegerMath.o | Арифметические операции с Integer |
| 20_IntegerComparison.o | Сравнение Integer |
| 21_RealOperations.o | Операции с Real |
| 22_IntegerRealMixed.o | Смешанные операции Integer/Real |
| 23_BooleanLogic.o | Логические операции |
| 24_ArrayOpearions.o | Операции с массивами |
| 25_ListOperations.o | Операции со списками |
| 26_IntegerUnaryMinus.o | Унарный минус |
| 27_RealComparison.o | Сравнение Real |
| 28_ComplexNesting.o | Сложная вложенность |

### Невалидные тесты (должны выдавать ошибки)

| Файл | Описание ошибки |
|------|-----------------|
| 11_SyntaxError.o | Синтаксическая ошибка (отсутствует end) |
| 12_TypeErrorReturn.o | Ошибка типа (return несовместимого типа) |
| 13_FieldAssignment.o | Прямое присваивание полю (запрещено) |
| 14_UndefinedMethod.o | Вызов несуществующего метода |
| 15_AmbiguousOverload.o | Неоднозначная перегрузка |
| 16_IncorrectNumber.o | Некорректное число |
| 17_IncorrectRealNumber.o | Некорректное вещественное число |
| 18_WithoutClass.o | Программа без класса |

### Дополнительные тесты

| Файл | Описание |
|------|----------|
| 29_CustomEntryPoint.o | Пользовательская точка входа |
| 30_ShortMethod.o | Короткая форма метода (=>) |

---

## Директория test-results/

Содержит результаты прогона тестов.

### Файлы результатов

**Для каждого теста**:
- `01.txt` - результат теста 01_Hello.o
- `02.txt` - результат теста 02_MaxInt.o
- ...
- `30.txt` - результат теста 30_ShortMethod.o

**Формат результата**:
```
========================================
O Language Compiler - Test Result
========================================
Test File:    01_Hello.o
Test Type:    Valid
Date:         2025-11-30 14:30:25
Duration:     245ms
Exit Code:    0
Status:       PASSED ✓
========================================

COMPILER OUTPUT:
========================================
[вывод компилятора]
========================================

TEST ANALYSIS:
========================================
Expected:     Successful compilation (exit 0)
Actual:       Exit code 0 (success)
Result:       TEST PASSED ✓
========================================
```

### summary.txt
**Назначение**: Сводный отчет по всем тестам  
**Содержание**:
- Общее количество тестов
- Количество пройденных/проваленных
- Pass rate (%)
- Детальная таблица результатов

---

## Директория build/

Содержит сгенерированные сборки и runtime конфигурации.

### Типичные файлы
- `output.dll` - сгенерированная сборка
- `output.runtimeconfig.json` - конфигурация runtime
- `app.dll`, `myapp.dll` - именованные сборки (из --emit-dll)

**Структура runtimeconfig.json**:
```json
{
  "runtimeOptions": {
    "tfm": "net9.0",
    "framework": {
      "name": "Microsoft.NETCore.App",
      "version": "9.0.0"
    }
  }
}
```

---

## Директория info/

Содержит всю документацию проекта (созданную MD файлами).

| Файл | Содержание |
|------|------------|
| 01_PROJECT_OVERVIEW.md | Обзор проекта и основные характеристики |
| 02_COMPILATION_PROCESS.md | Детальное описание процесса компиляции |
| 03_TECHNOLOGY_STACK.md | Описание используемых технологий |
| 04_CLI_FLAGS.md | Полный список флагов командной строки |
| 05_PROJECT_STRUCTURE.md | Структура проекта (этот файл) |

---

## Неиспользуемые файлы

Следующие файлы не относятся к основному функционалу компилятора:

- `.git/` - git репозиторий (не описан)
- `.vs/`, `.idea/` - файлы IDE (не описаны)
- `bin/`, `obj/` - временные файлы сборки (не описаны)
- `*.user`, `*.suo` - пользовательские настройки IDE (не описаны)

---

## Размеры директорий

| Директория | Файлов | Строк кода | % от проекта |
|------------|--------|------------|--------------|
| src/OCompiler/CodeGeneration/ | 6 | ~3,000 | 20% |
| src/OCompiler/Semantic/ | 5 | ~3,500 | 23% |
| src/OCompiler/Parser/ | 4 | ~1,500 | 10% |
| src/OCompiler/Lexer/ | 6 | ~1,000 | 7% |
| src/OCompiler/Runtime/ | 1 | ~250 | 2% |
| tests/ | 30 | ~1,500 | 10% |
| info/ | 5 | ~4,000 | 27% |
| Scripts | 3 | ~800 | 5% |

---

*Документация структуры проекта O Language Compiler*
